{% extends "base.html" %}

{% block title %}{{ product.name }} - PriceChecker{% endblock %}

{% block content %}
<!-- Corrigez le breadcrumb en haut de page -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Accueil</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('main.products') }}">Produits</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
    </ol>
</nav>
<div class="row">
    <div class="col-md-12">
        <!-- En-t√™te du produit -->
        <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{ product.name }}</h1>
        {% if product.description %}
        <p class="text-muted">{{ product.description }}</p>
        {% endif %}
    </div>
    <div>
        <!-- Bouton de mise √† jour rapide des prix -->
        {% if links %}
        <form method="POST" action="{{ url_for('main.quick_scrape_product', product_id=product.id) }}" class="d-inline">
            <button type="submit" class="btn btn-outline-primary me-2" 
                    onclick="this.disabled=true; this.innerHTML='<i class=\'bi bi-hourglass-split\'></i> Scraping...'; this.form.submit();">
                <i class="bi bi-arrow-clockwise"></i> Mettre √† jour les prix
            </button>
        </form>
        {% endif %}
        <a href="{{ url_for('main.edit_product', product_id=product.id) }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-pencil"></i> Modifier
        </a>
        <a href="{{ url_for('main.products') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Liste des produits
        </a>
        <button type="button" class="btn btn-outline-danger" onclick="confirmDeleteProduct('{{ product.id }}', '{{ product.name|e }}')">
            <i class="fas fa-trash"></i> Supprimer
        </button>
    </div>
</div>

        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <p class="text-muted">{{ product.description or 'Aucune description' }}</p>
                <small class="text-muted">
                    üìÖ Ajout√© le {{ product.created_at.split(' ')[0] if product.created_at else 'Date inconnue' }}
                </small>
            </div>
        </div>

        <!-- Liens de boutiques -->
        <div class="row mb-4">
            <div class="col-md-12">
                <h3>üîó Liens de boutiques</h3>
                {% set links = get_product_links(product.id) %}
                {% if links %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Boutique</th>
                                    <th>URL</th>
                                    <th>Prix actuel</th>
                                    <th>S√©lecteur CSS</th>
                                    <th>Ajout√© le</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for link in links %}
                                <tr>
                                    <td>
                                        <strong>{{ link.shop_name }}</strong>
                                    </td>
                                    <td>
                                        <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            üîó Ouvrir
                                        </a>
                                    </td>
                                    <td>
                                        <!-- ‚úÖ LOGIQUE CORRIG√âE : utiliser selectattr pour filtrer -->
                                        {% set matching_prices = prices | selectattr('shop_name', 'equalto', link.shop_name) | list %}

                                        {% if matching_prices %}
                                            {% set price = matching_prices[0] %}
                                            {% if price.price %}
                                                <span class="badge bg-success">{{ "%.2f"|format(price.price) }} {{ price.currency }}</span>
                                                {% if not price.is_available %}
                                                    <br><small class="text-warning">‚ö†Ô∏è Indisponible</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-secondary">Prix √† venir</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">Prix √† venir</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if link.css_selector %}
                                            <code class="small">{{ link.css_selector[:30] }}{% if link.css_selector|length > 30 %}...{% endif %}</code>
                                        {% else %}
                                            <span class="text-muted">Aucun</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ link.created_at.split(' ')[0] if link.created_at else 'N/A' }}
                                        </small>
                                    </td>
                                    <td>
                                        <form method="POST"
                                              action="{{ url_for('main.delete_link', product_id=product.id, link_id=link.id) }}"
                                              style="display: inline;"
                                              onsubmit="return confirm('Supprimer ce lien de {{ link.shop_name }} ?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                üóëÔ∏è Supprimer
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- ‚úÖ BOUTON AJOUT : maintenant affich√© m√™me quand il y a d√©j√† des liens -->
                    <div class="mt-3">
                        <a href="{{ url_for('main.add_product_link_route', product_id=product.id) }}"
                           class="btn btn-success">
                            ‚ûï Ajouter un nouveau lien
                        </a>
                    </div>

                {% else %}
                    <div class="alert alert-info">
                        <h6 class="alert-heading">‚ÑπÔ∏è Aucun lien configur√©</h6>
                        <p class="mb-2">Aucun lien de boutique n'a encore √©t√© ajout√© pour ce produit.</p>
                        <a href="{{ url_for('main.add_product_link_route', product_id=product.id) }}"
                           class="btn btn-primary btn-sm">
                            ‚ûï Ajouter le premier lien
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Prix actuels (historique) -->
        <div class="row">
            <div class="col-md-12">
                <h3>üí∞ Historique des prix</h3>
                
                {% if prices %}
                    <div class="row">
                        {% for price in prices %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h5 class="card-title">{{ price.shop_name }}</h5>
                                        {% if price.is_available and price.price %}
                                            <span class="badge bg-success">Disponible</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Indisponible</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if price.price %}
                                        <h4 class="text-primary">{{ "%.2f"|format(price.price) }} {{ price.currency }}</h4>
                                    {% else %}
                                        <h4 class="text-muted">Prix non disponible</h4>
                                    {% endif %}
                                    
                                    {% if price.error_message %}
                                        <small class="text-danger">{{ price.error_message }}</small>
                                    {% endif %}
                                    
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            Derni√®re v√©rification : {{ price.scraped_at.split(' ')[0] if price.scraped_at else 'Jamais' }}
                                        </small>
                                    </div>
                                    
                                    {% if price.url %}
                                    <div class="mt-2">
                                        <a href="{{ price.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            üîó Voir sur {{ price.shop_name }}
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">‚ö†Ô∏è Aucun prix dans l'historique</h6>
                        <p class="mb-0">
                            Aucun prix n'a encore √©t√© collect√© pour ce produit. 
                            Les prix appara√Ætront ici apr√®s la premi√®re collecte automatique.
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmer la suppression
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    <strong>‚ö†Ô∏è Attention !</strong> Cette action est irr√©versible.
                </p>
                <p>
                    Voulez-vous vraiment supprimer le produit <strong>{{ product.name }}</strong> ?
                </p>
                <p class="text-muted small">
                    Cela supprimera √©galement :
                </p>
                <ul class="text-muted small">
                    <li>Tous les liens vers les boutiques ({{ product_links|length }} liens)</li>
                    <li>Tout l'historique des prix collect√©s</li>
                    <li>Toutes les statistiques associ√©es</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <form method="POST" action="{{ url_for('main.delete_product_route', product_id=product.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Supprimer d√©finitivement
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDeleteProduct(productId, productName) {
    // Afficher le modal de confirmation
    const modal = new bootstrap.Modal(document.getElementById('deleteProductModal'));
    modal.show();
}
</script>

{% endblock %}